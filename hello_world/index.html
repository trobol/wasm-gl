<html>

<head>
	<script>
		if (!('WebAssembly' in window)) {
			var msg = 'WebAssembly not supported';
			alert(msg);
			console.error(msg);
		}
		function loadWebAssembly(filename, imports) {
			return fetch(filename)
				.then(response => response.arrayBuffer())
				.then(buffer => WebAssembly.compile(buffer))
				.then(module => {
					imports = imports || {};
					imports.env = imports.env || {};
					if (!imports.env.memory) {
						// Setup our Memory import, initializing it
						// to use 256 pages of memory.
						imports.env.memory = new WebAssembly.Memory({ initial: 256 });
					}
					if (!imports.env.__indirect_function_table) {
						// Setup our Table with an inital size of 0,
						// 'anyfunc' is currently the option here
						imports.env.__indirect_function_table = new WebAssembly.Table({ initial: 0, element: 'anyfunc' });
					}
					var consoleDiv = document.getElementById('console');
					imports.env.out = function consoleLogString(offset, length) {
						// Convert the bytes stored in our memory buffer
						// at position offset.
						var bytes = new Uint8Array(imports.env.memory.buffer, offset, length);
						// Convert our byte array to a utf8 string
						var string = new TextDecoder('utf8').decode(bytes);
						// Append the string to the DOM
						var content = document.createTextNode(string);
						consoleDiv.appendChild(content);
						console.log(bytes);
					}
					// Create a WebAssembly instance with our compiled
					// module and pass in our import object
					return new WebAssembly.Instance(module, imports);
				});
		}
		// Call our load function.
		loadWebAssembly('hello_world.wasm').then(instance => {
			// Grab our exports and call our main function
			var exports = instance.exports;
			var main = exports.main;
			main();
		});
	</script>
</head>

<body>
	<div id="console"></div>
</body>

</html>